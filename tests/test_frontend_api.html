<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端API测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #log { background: #f5f5f5; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>前端功能测试</h1>
    
    <div class="test-section">
        <h3>1. 登录测试</h3>
        <button onclick="testLogin()">测试登录</button>
        <button onclick="testDevices()">测试设备列表</button>
        <button onclick="testWebRTC()">测试WebRTC服务</button>
    </div>
    
    <div class="test-section">
        <h3>2. 功能按钮测试</h3>
        <button onclick="testAllButtons()">测试所有按钮</button>
        <button onclick="clearLog()">清除日志</button>
    </div>
    
    <div id="log"></div>

    <script>
        const log = document.getElementById('log');
        let token = null;

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        async function testLogin() {
            try {
                addLog('正在测试登录...');
                const response = await fetch('http://localhost:8090/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'username=admin&password=admin123'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    addLog('✅ 登录成功', 'success');
                    addLog(`Token: ${token.substring(0, 20)}...`);
                } else {
                    addLog(`❌ 登录失败: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`❌ 登录错误: ${error.message}`, 'error');
            }
        }

        async function testDevices() {
            if (!token) {
                addLog('请先登录获取token');
                return;
            }
            
            try {
                addLog('正在测试设备列表...');
                const response = await fetch('http://localhost:8090/devices', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const devices = await response.json();
                    addLog(`✅ 设备列表成功 - ${devices.length}个设备`, 'success');
                    
                    // 检查录像机二
                    const nvr2 = devices.find(d => d.name && d.name.includes('录像机二'));
                    if (nvr2) {
                        addLog(`✅ 录像机二: ${nvr2.ip}:${nvr2.port}`, 'success');
                    }
                } else {
                    addLog(`❌ 设备列表失败: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`❌ 设备列表错误: ${error.message}`, 'error');
            }
        }

        async function testWebRTC() {
            try {
                addLog('正在测试WebRTC服务...');
                const response = await fetch('http://localhost:8081/api/health');
                
                if (response.ok) {
                    addLog('✅ WebRTC服务正常', 'success');
                } else {
                    addLog(`❌ WebRTC服务异常: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`❌ WebRTC服务错误: ${error.message}`, 'error');
            }
        }

        function testAllButtons() {
            addLog('测试所有功能按钮...');
            
            // 模拟按钮点击测试
            const buttons = [
                { name: '刷新设备', action: () => testDevices() },
                { name: '登录', action: () => testLogin() },
                { name: 'WebRTC测试', action: () => testWebRTC() }
            ];
            
            buttons.forEach(btn => {
                try {
                    btn.action();
                    addLog(`✅ ${btn.name} 按钮正常`, 'success');
                } catch (error) {
                    addLog(`❌ ${btn.name} 按钮异常: ${error.message}`, 'error');
                }
            });
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // 页面加载时自动测试
        window.addEventListener('load', () => {
            addLog('页面加载完成，开始测试...');
            setTimeout(testLogin, 1000);
        });
    </script>
</body>
</html>