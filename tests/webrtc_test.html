<!DOCTYPE html>
<html>
<head>
    <title>WebRTCè¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .video-container { width: 640px; height: 480px; border: 1px solid #ccc; }
        video { width: 100%; height: 100%; }
        button { padding: 10px 20px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>WebRTCè¿æ¥æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkServerStatus()">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</button>
        <div id="status-result" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>2. SDPäº¤æ¢æµ‹è¯•</h2>
        <button onclick="testSDPExchange()">æµ‹è¯•SDPäº¤æ¢</button>
        <div id="sdp-result" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>3. å®æ—¶è§†é¢‘æµ‹è¯•</h2>
        <button onclick="startVideoTest()">å¼€å§‹è§†é¢‘æµ‹è¯•</button>
        <button onclick="stopVideoTest()">åœæ­¢è§†é¢‘</button>
        <div class="video-container">
            <video id="test-video" autoplay muted playsinline></video>
        </div>
        <div id="video-log" class="log"></div>
    </div>

    <script>
        let pc = null;
        let videoElement = null;

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            container.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        async function checkServerStatus() {
            const result = document.getElementById('status-result');
            result.innerHTML = '';
            
            try {
                const response = await fetch('http://localhost:8090/health');
                const data = await response.json();
                
                log('status-result', `âœ… å¥åº·æ£€æŸ¥æˆåŠŸ: ${response.status}`, 'success');
                log('status-result', `ğŸ“Š çŠ¶æ€: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('status-result', `âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testSDPExchange() {
            const result = document.getElementById('sdp-result');
            result.innerHTML = '';
            
            try {
                // åˆ›å»ºPeerConnection
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                // åˆ›å»ºoffer
                const offer = await pc.createOffer({
                    offerToReceiveAudio: false,
                    offerToReceiveVideo: true
                });
                await pc.setLocalDescription(offer);

                log('sdp-result', `ğŸ“¤ å‘é€offer: ${offer.sdp.length} å­—ç¬¦`);

                // å‘é€åˆ°æœåŠ¡å™¨
                const response = await fetch('http://localhost:8090/api/offer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sdp: offer.sdp,
                        rtsp_url: 'test://demo/video',
                        type: 'main'
                    })
                });

                const data = await response.json();
                log('sdp-result', `ğŸ“¥ æ”¶åˆ°å“åº”: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (data.success && data.sdp) {
                    log('sdp-result', `âœ… SDPäº¤æ¢æˆåŠŸ: ${data.sdp.length} å­—ç¬¦`, 'success');
                    
                    // éªŒè¯æŒ‡çº¹æ ¼å¼
                    const fingerprintMatch = data.sdp.match(/a=fingerprint:sha-256 ([0-9A-F:]{95})/);
                    if (fingerprintMatch) {
                        log('sdp-result', `ğŸ”‘ æŒ‡çº¹: ${fingerprintMatch[1]}`, 'success');
                    }
                } else {
                    log('sdp-result', `âŒ SDPäº¤æ¢å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }

                pc.close();
            } catch (error) {
                log('sdp-result', `âŒ SDPäº¤æ¢å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function startVideoTest() {
            const logContainer = document.getElementById('video-log');
            logContainer.innerHTML = '';
            videoElement = document.getElementById('test-video');
            
            try {
                log('video-log', 'ğŸ”„ å¼€å§‹WebRTCè§†é¢‘æµ‹è¯•...');

                // åˆ›å»ºPeerConnection
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                // è®¾ç½®äº‹ä»¶ç›‘å¬
                pc.ontrack = (event) => {
                    log('video-log', 'ğŸ“¹ æ”¶åˆ°è§†é¢‘è½¨é“', 'success');
                    videoElement.srcObject = event.streams[0];
                };

                pc.onconnectionstatechange = () => {
                    log('video-log', `ğŸ”— è¿æ¥çŠ¶æ€: ${pc.connectionState}`);
                    if (pc.connectionState === 'connected') {
                        log('video-log', 'âœ… WebRTCè¿æ¥æˆåŠŸ', 'success');
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    log('video-log', `ğŸ§Š ICEçŠ¶æ€: ${pc.iceConnectionState}`);
                    if (pc.iceConnectionState === 'failed') {
                        log('video-log', 'âŒ ICEè¿æ¥å¤±è´¥', 'error');
                    }
                };

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        log('video-log', `ğŸ¯ ICEå€™é€‰: ${event.candidate.type}`);
                    }
                };

                // åˆ›å»ºå¹¶å‘é€offer
                const offer = await pc.createOffer({
                    offerToReceiveAudio: false,
                    offerToReceiveVideo: true
                });
                await pc.setLocalDescription(offer);

                log('video-log', `ğŸ“¤ å‘é€offer: ${offer.sdp.length} å­—ç¬¦`);

                // å‘é€åˆ°æœåŠ¡å™¨
                const response = await fetch('http://localhost:8090/api/offer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sdp: offer.sdp,
                        rtsp_url: 'test://demo/video',
                        type: 'main'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.sdp) {
                    log('video-log', `ğŸ“¥ æ”¶åˆ°answer: ${data.sdp.length} å­—ç¬¦`);
                    
                    // è®¾ç½®è¿œç¨‹æè¿°
                    await pc.setRemoteDescription({
                        type: data.type || 'answer',
                        sdp: data.sdp
                    });
                    
                    log('video-log', 'âœ… SDPè®¾ç½®å®Œæˆï¼Œç­‰å¾…è§†é¢‘æµ...', 'success');
                } else {
                    log('video-log', `âŒ æœåŠ¡å™¨å“åº”é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }

            } catch (error) {
                log('video-log', `âŒ è§†é¢‘æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                if (pc) pc.close();
            }
        }

        function stopVideoTest() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (videoElement && videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            document.getElementById('video-log').innerHTML += '<div>ğŸ›‘ è§†é¢‘æµ‹è¯•å·²åœæ­¢</div>';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.addEventListener('load', () => {
            checkServerStatus();
        });
    </script>
</body>
</html>