<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>监控测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .device-info {
            background: #1a1a1a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .video-container {
            background: #000;
            border: 1px solid #333;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .video-element {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border: 1px solid #666;
        }
        .log {
            background: #111;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #44ff44;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>监控测试页面</h1>
        
        <div>
            <button onclick="testDeviceData()">测试设备数据</button>
            <button onclick="testWebRTC()">测试WebRTC</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
        
        <div class="log" id="log"></div>
        
        <div id="deviceList"></div>
        
        <div class="video-container" id="videoContainer" style="display: none;">
            <h3>WebRTC视频测试</h3>
            <video id="testVideo" class="video-element" autoplay muted playsinline></video>
        </div>
    </div>

    <script>
        const log = document.getElementById('log');
        const deviceList = document.getElementById('deviceList');
        const videoContainer = document.getElementById('videoContainer');
        const testVideo = document.getElementById('testVideo');

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = '';
        }

        async function testDeviceData() {
            try {
                addLog('正在获取设备数据...');
                const response = await fetch('/api/devices');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const devices = await response.json();
                addLog(`成功获取 ${devices.length} 个设备`);
                
                deviceList.innerHTML = '';
                devices.forEach((device, index) => {
                    const div = document.createElement('div');
                    div.className = 'device-info';
                    div.innerHTML = `
                        <h4>设备 ${index + 1}: ${device.name}</h4>
                        <p><strong>ID:</strong> ${device.id}</p>
                        <p><strong>IP:</strong> ${device.ip}</p>
                        <p><strong>端口:</strong> ${device.port}</p>
                        <p><strong>协议:</strong> ${device.protocol}</p>
                        <p><strong>状态:</strong> ${device.status}</p>
                        <p><strong>通道:</strong> ${device.chs}</p>
                        <p><strong>RTSP URL:</strong> ${buildRtspUrl(device)}</p>
                    `;
                    deviceList.appendChild(div);
                });
                
            } catch (error) {
                addLog(`获取设备数据失败: ${error.message}`, 'error');
            }
        }

        function buildRtspUrl(device) {
            const ip = device.ip || '127.0.0.1';
            const port = device.port || 554;
            const user = device.user || 'admin';
            const pwd = device.pwd || 'password';
            const chs = device.chs || 1;
            
            return `rtsp://${user}:${pwd}@${ip}:${port}/Streaming/Channels/${chs}01`;
        }

        async function testWebRTC() {
            try {
                addLog('开始WebRTC测试...');
                
                // 获取设备数据
                const response = await fetch('/api/devices');
                const devices = await response.json();
                
                if (devices.length === 0) {
                    addLog('没有找到设备', 'error');
                    return;
                }
                
                // 使用第一个在线的RTSP设备
                const targetDevice = devices.find(d => d.status === 'online' && d.protocol === 'rtsp');
                if (!targetDevice) {
                    addLog('没有找到在线的RTSP设备', 'error');
                    return;
                }
                
                const rtspUrl = buildRtspUrl(targetDevice);
                addLog(`使用RTSP地址: ${rtspUrl}`);
                
                videoContainer.style.display = 'block';
                
                // 创建WebRTC连接
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.ontrack = (event) => {
                    addLog('收到视频轨道', 'success');
                    testVideo.srcObject = event.streams[0];
                };
                
                pc.onconnectionstatechange = () => {
                    addLog(`连接状态: ${pc.connectionState}`);
                };
                
                // 创建offer
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await pc.setLocalDescription(offer);
                addLog('创建SDP offer成功');
                
                // 发送到WebRTC服务器
                const response2 = await fetch('http://localhost:8091/api/stream/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'main',
                        clientId: `test_${Date.now()}`,
                        rtsp_url: rtspUrl
                    })
                });
                
                if (!response2.ok) {
                    throw new Error(`WebRTC服务器错误: ${response2.status}`);
                }
                
                const data = await response2.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.sdp) {
                    await pc.setRemoteDescription({ type: 'offer', sdp: data.sdp });
                    addLog('设置远程描述成功', 'success');
                }
                
            } catch (error) {
                addLog(`WebRTC测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动测试
        window.addEventListener('load', () => {
            addLog('测试页面已加载');
            setTimeout(testDeviceData, 1000);
        });
    </script>
</body>
</html>