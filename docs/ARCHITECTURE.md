# 🏗️ 系统架构详解

## 📊 六层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         ⑥ 权限/安全层                            │
│                    JWT认证 + 角色权限控制                        │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                         ⑤ 前端页面层                            │
│   Vue3 + ElementPlus + flv.js + WebRTC + 响应式设计              │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│   │   监控画面   │ │   设备管理   │ │   系统设置   │               │
│   └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                         ④ 流媒体层                              │
│   本地WebRTC服务 + HEVC兼容服务 + RTSP协议转换                    │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│   │   RTSP输入   │ │ HEVC转换服务 │ │  WebRTC输出  │               │
│   └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                         ③ 信令/设备管理层                       │
│   FastAPI + SQLite + RESTful API + 设备发现 + 状态监控            │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│   │   设备管理   │ │   用户认证   │ │   权限控制   │               │
│   └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                         ② 视频网关层                           │
│   本地WebRTC服务 + 协议转换 + 缓存优化                          │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│   │   RTSP网关   │ │   HTTP网关   │ │   WebRTC网关 │               │
│   └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                         ① 操作系统层                           │
│   Windows/Linux + 本地直接运行 + 资源监控 + 网络配置              │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│   │   网络配置   │ │   存储管理   │ │   资源监控   │               │
│   └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 技术栈详解

### 前端技术栈
- **Vue 3.3+**: 渐进式JavaScript框架
- **TypeScript 5.0+**: 类型安全的JavaScript
- **Element Plus 2.4+**: Vue 3 UI组件库
- **Vite 5.0+**: 下一代前端构建工具
- **Pinia 2.1+**: 状态管理库

### 后端技术栈
- **FastAPI 0.104.0**: 现代、快速、基于Python 3.7+的Web框架
- **SQLAlchemy 2.0**: Python SQL工具包
- **SQLite**: 轻量级单文件数据库
- **PyJWT**: JSON Web Token实现

### 流媒体技术栈
- **WebRTC**: 浏览器实时通信技术
- **HEVC兼容服务**: H.265转H.264专用转换服务
- **FFmpeg**: 视频转码
- **flv.js**: 前端FLV播放

## 🔄 数据流向图

```
监控摄像头 → RTSP流 → 本地WebRTC服务 → HEVC兼容服务 → WebRTC → 浏览器
     ↓           ↓              ↓               ↓          ↓            ↓
   192.168.x.x  554端口       8081端口         8090端口     多协议输出   实时播放
```

## 🏠 本地服务架构

```
┌─────────────────────────────────────────────────────────────┐
│                        本地服务器                             │
│                      Windows/Linux                           │
└─────────────────────────────────────────────────────────────┘
        │                │                │                │
   ┌────┴────┐      ┌────┴────┐      ┌────┴────┐      ┌────┴────┐
   │ frontend │      │ backend │      │ WebRTC  │      │ HEVC    │
   │  :5173   │      │ :8004   │      │ :8081   │      │ :8090   │
   │  WebUI   │      │  API    │      │ 服务    │      │ 转换服务 │
   └──────────┘      └─────────┘      └─────────┘      └─────────┘
```

## 📁 项目结构

### 前端结构
```
frontend/
├── src/
│   ├── api/              # API接口定义
│   ├── components/       # 通用组件
│   ├── views/            # 页面组件
│   ├── stores/           # 状态管理
│   └── utils/            # 工具函数
```

### 后端结构
```
backend/
├── app/
│   ├── api/              # API路由
│   ├── models/           # 数据模型
│   ├── schemas/          # Pydantic模式
│   ├── crud/             # 数据库操作
│   └── utils/            # 工具函数
```

## 📈 性能指标

### 单机性能
- **最大连接数**：1000个并发
- **视频延迟**：WebRTC < 500ms，FLV < 3s
- **CPU使用率**：< 80%（1080p 25fps x 16路）
- **内存使用**：< 8GB
- **网络带宽**：每路1080p约4Mbps

### 扩展架构
```
                   ┌─────────────────┐
                   │   负载均衡器     │
                   │   Nginx/HAProxy │
                   └─────────────────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │   SRS节点1   │ │   SRS节点2   │ │   SRS节点3   │
    │  192.168.1.10│ │ 192.168.1.11 │ │ 192.168.1.12 │
    └─────────────┘ └─────────────┘ └─────────────┘
```

## 🔐 安全架构

### 网络安全
```
互联网 ─┬─ CDN ─┬─ 防火墙 ─┬─ 负载均衡 ─┬─ 应用服务器
        │        │          │            │
       WAF     限流       端口过滤      认证授权
```

### 数据安全
- **传输加密**：HTTPS + WSS
- **存储加密**：数据库加密存储
- **访问控制**：基于角色的权限管理
- **审计日志**：完整的操作记录

## 📊 监控告警

### 系统监控
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   指标采集   │───▶│   告警规则   │───▶│   通知渠道   │
│   Prometheus │    │   AlertManager│    │   钉钉/邮件  │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 监控指标
- **服务可用性**：HTTP/TCP探针
- **资源使用率**：CPU/内存/磁盘/网络
- **业务指标**：在线设备数/播放次数/错误率
- **性能指标**：延迟/吞吐量/并发数

## 🚀 部署策略

### 本地直接运行
```bash
# 确保已安装Python 3.8+和Node.js 16+
# 安装后端依赖
pip install -r backend/requirements.txt

# 安装前端依赖
cd frontend
npm install
cd ..

# 启动服务（需要3个终端）
# 终端1: 启动后端服务
python backend/main.py

# 终端2: 启动前端服务
cd frontend
npm run dev
cd ..

# 终端3: 启动HEVC兼容WebRTC服务器
python scripts/webrtc/hevc_compat_server.py --port 8090

# 所有服务启动后，访问http://localhost:5173
```

### 本地资源配置
| 项目 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 双核 | 4核以上 |
| 内存 | 4GB | 8GB以上 |
| 磁盘 | 100MB可用空间 | 500MB以上 |
| 网络 | 100Mbps | 1Gbps（多路视频） |

## 🎯 总结

本系统采用轻量级的本地直接运行架构，具备以下特点：

- **轻量级**：SQLite单文件数据库，无需复杂配置
- **高性能**：WebRTC超低延迟，支持多路视频监控
- **兼容性强**：专用HEVC兼容服务确保H.265视频正常播放
- **跨平台**：支持Windows和Linux系统
- **易维护**：提供完整的监控和故障排查工具
- **零成本**：开源方案，无许可费用，内置测试设备

通过这套架构，您可以在15分钟内完成从安装到运行的完整部署，并获得稳定的视频监控体验！